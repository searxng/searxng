{"version":3,"file":"zqe8pfDB.min.js","names":[],"sources":["../../../../../client/simple/src/js/plugin/QuickSummary.ts"],"sourcesContent":["// SPDX-License-Identifier: AGPL-3.0-or-later\n\nimport { Plugin } from \"../Plugin.ts\";\nimport { http } from \"../toolkit.ts\";\nimport { getElement } from \"../util/getElement.ts\";\n\n/**\n * Async loading of AI-powered Quick Summary.\n */\nexport default class QuickSummary extends Plugin {\n  protected constructor() {\n    super(\"quickSummary\");\n  }\n\n  protected async run(): Promise<boolean> {\n    const summaryElement = getElement<HTMLElement>(\"quick_summary\");\n    if (!summaryElement) return false;\n\n    const bodyElement = summaryElement.querySelector<HTMLElement>(\".quick-summary-body\");\n    if (!bodyElement) return false;\n\n    // Extract query and results data from DOM\n    const queryInput = document.querySelector<HTMLInputElement>(\"#q\");\n    const query = queryInput?.value?.trim();\n    \n    // Get top N results based on settings\n    const maxResults = (window as any).quick_summary_max_results || 10;\n    const resultElements = Array.from(document.querySelectorAll<HTMLElement>(\"#urls article.result\"))\n      .slice(0, maxResults);\n\n    if (!query || resultElements.length === 0) return false;\n\n    const results = resultElements.map((el, idx) => ({\n      index: idx,\n      title: el.querySelector(\".result_title a\")?.textContent || el.querySelector(\"h3\")?.textContent || '',\n      url: el.querySelector(\".result_title a\")?.href || el.querySelector(\"a\")?.href || '',\n      content: el.querySelector(\".content\")?.textContent || ''\n    }));\n\n    try {\n      // Call async endpoint\n      const res = await http(\"POST\", \"/quick_summary\", {\n        body: JSON.stringify({ q: query, results }),\n        timeout: 35000\n      });\n\n      const data = await res.json();\n\n      if (data.error) {\n        this.showError(data.error);\n      } else {\n        this.renderSummary(data);\n      }\n    } catch (error) {\n      console.error(\"Quick Summary error:\", error);\n      this.showError(\"Failed to generate summary. Please try again.\");\n    }\n\n    return true;\n  }\n\n  protected async post(_result: boolean): Promise<void> {\n    // Register collapse button handler\n    const collapseBtn = document.getElementById(\"collapse_quick_summary\");\n    collapseBtn?.addEventListener(\"click\", () => {\n      const summaryElement = document.getElementById(\"quick_summary\");\n      summaryElement?.classList.toggle(\"collapsed\");\n      const icon = collapseBtn.querySelector(\"svg\");\n      if (summaryElement?.classList.contains(\"collapsed\")) {\n        icon?.classList.add(\"rotate-180\");\n      } else {\n        icon?.classList.remove(\"rotate-180\");\n      }\n    });\n\n    // Register retry button handler\n    const retryBtn = document.getElementById(\"retry_quick_summary\");\n    retryBtn?.addEventListener(\"click\", () => {\n      void this.run();\n    });\n  }\n\n  private renderSummary(data: any): void {\n    const summaryElement = document.getElementById(\"quick_summary\");\n    const bodyElement = summaryElement?.querySelector<HTMLElement>(\".quick-summary-body\");\n    \n    if (!bodyElement) return;\n\n    // Format summary with clickable citations\n    const formattedSummary = this.formatWithCitations(data.summary, data.citations);\n    \n    // Build citations list HTML\n    let citationsHtml = '';\n    if (data.citations && data.citations.length > 0) {\n      const translations = (window as any).translations || {};\n      citationsHtml = `\n        <div class=\"quick-summary-citations\">\n          <h5>${translations.Sources || 'Sources'}</h5>\n          <ul>\n            ${data.citations.map((c: any, i: number) => `\n              <li>\n                <sup><a href=\"#result-${c.result_index}\" class=\"citation-link\">[${c.index}]</a></sup>\n                <a href=\"#result-${c.result_index}\" class=\"citation-title\">${this.escapeHtml(c.title)}</a>\n              </li>\n            `).join('')}\n          </ul>\n        </div>\n      `;\n    }\n\n    bodyElement.innerHTML = `\n      <div class=\"quick-summary-content\">\n        <div class=\"quick-summary-text\">\n          ${formattedSummary}\n        </div>\n        ${citationsHtml}\n      </div>\n    `;\n\n    // Scroll to first citation when clicked\n    bodyElement.querySelectorAll<HTMLElement>(\".citation-link\").forEach(link => {\n      link.addEventListener(\"click\", (e) => {\n        const targetId = link.getAttribute(\"href\");\n        if (targetId?.startsWith(\"#result-\")) {\n          e.preventDefault();\n          const targetElement = document.querySelector<HTMLElement>(targetId);\n          targetElement?.scrollIntoView({ behavior: \"smooth\", block: \"start\" });\n        }\n      });\n    });\n  }\n\n  private formatWithCitations(text: string, citations: any[]): string {\n    if (!citations || citations.length === 0) return this.escapeHtml(text);\n\n    // Replace [1], [2], etc. with clickable citation links\n    let formatted = this.escapeHtml(text);\n    \n    citations.forEach((c: any) => {\n      const citationPattern = new RegExp(`\\\\[${c.index}\\\\]`, 'g');\n      formatted = formatted.replace(citationPattern, \n        `<a href=\"#result-${c.result_index}\" class=\"citation-link\">[${c.index}]</a>`\n      );\n    });\n\n    return formatted;\n  }\n\n  private showError(message: string): void {\n    const summaryElement = document.getElementById(\"quick_summary\");\n    const bodyElement = summaryElement?.querySelector<HTMLElement>(\".quick-summary-body\");\n    \n    if (!bodyElement) return;\n\n    bodyElement.innerHTML = `\n      <div class=\"quick-summary-error\" role=\"alert\">\n        <p>${this.escapeHtml(message)}</p>\n        <button id=\"retry_quick_summary\" type=\"button\">\n          ${this.escapeHtml((window as any).translations?.Retry || 'Retry')}\n        </button>\n      </div>\n    `;\n    \n    // Re-register retry button for new error state\n    document.getElementById(\"retry_quick_summary\")?.addEventListener(\"click\", () => {\n      void this.run();\n    });\n  }\n\n  private escapeHtml(text: string): string {\n    const div = document.createElement(\"div\");\n    div.textContent = text;\n    return div.innerHTML;\n  }\n}\n"],"mappings":"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"}